<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Atividades - Projeto IntegraCAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Terra Cota & Creme -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff7ed;
        }
        .tab-active {
            border-color: #c2410c;
            color: #c2410c;
            font-weight: 600;
        }
        .flowchart-step {
            transition: all 0.3s ease;
            cursor: grab; /* Indica que √© arrast√°vel */
        }
        .flowchart-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flowchart-arrow {
            font-size: 2.5rem;
            line-height: 1;
            color: #d1d5db;
            padding: 0 0.5rem;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .kanban-card:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Custom class for the responsive chart container height */
        .chart-container {
            position: relative; 
            width: 100%; 
            height: 300px; /* Base height */
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }
        /* Estilo para desabilitar o input de forma visual mais clara */
        #modal-end-date:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        /* Estilo para campos edit√°veis inline */
        .edit-title, .edit-desc {
            min-height: 1.25rem;
            outline: none;
            border-bottom: 1px solid transparent;
            cursor: text;
        }
        .edit-title:focus, .edit-desc:focus {
            border-bottom-color: #c2410c;
            background-color: #fee2e2;
            padding-bottom: 1px;
        }
        .capacitacao-list-item:hover .delete-btn {
            opacity: 1;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-xl font-semibold text-orange-700">Conectando ao Firebase...</div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-orange-900">Relat√≥rio Interativo de Atividades</h1>
            <p class="text-lg text-orange-800 mt-1">Projeto IntegraCAR</p>
        </header>

        <nav class="flex justify-center border-b border-orange-200 mb-8 flex-wrap">
            <button data-tab="overview" class="py-4 px-6 text-sm sm:text-base border-b-2 tab-active">Vis√£o Geral</button>
            <button data-tab="capacitacao" class="py-4 px-6 text-sm sm:text-base border-b-2 border-transparent hover:border-orange-300 transition-colors">Capacita√ß√£o</button>
            <button data-tab="fluxo" class="py-4 px-6 text-sm sm:text-base border-b-2 border-transparent hover:border-orange-300 transition-colors">Fluxo Operacional</button>
            <button data-tab="ti" class="py-4 px-6 text-sm sm:text-base border-b-2 border-transparent hover:border-orange-300 transition-colors">TI & Automa√ß√£o</button>
        </nav>

        <main id="content">
            
            <section id="overview" class="tab-content space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-orange-900 mb-2">Vis√£o Geral do Projeto</h2>
                    <p class="text-gray-600">Este painel resume as principais frentes de trabalho. A fase inicial concentrou-se na estrutura√ß√£o f√≠sica e capacita√ß√£o da equipe, evoluindo para o desenho de processos e a defini√ß√£o de requisitos tecnol√≥gicos cruciais para a automa√ß√£o das an√°lises do CAR. O total de atividades √© baseado nos pilares Capacita√ß√£o, Fluxo Operacional e TI & Automa√ß√£o.</p>
                </div>
                
                <!-- BLOCO DE FILTRO DE RELAT√ìRIO -->
                <div class="bg-orange-50 p-6 rounded-xl shadow-inner border border-orange-200">
                    <h3 class="text-xl font-bold text-orange-900 mb-4 flex items-center">
                        <span class="mr-2">üìÖ</span> Relat√≥rio Mensal de Atividades e Exporta√ß√£o
                    </h3>
                    <form id="report-filter-form" class="flex flex-col sm:flex-row gap-3 items-end">
                        <div class="flex-1 w-full sm:w-auto">
                            <label for="filter-month" class="block text-sm font-medium text-gray-700 mb-1">M√™s</label>
                            <select id="filter-month" class="w-full p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 bg-white" required>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <label for="filter-year" class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
                            <select id="filter-year" class="w-full p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 bg-white" required>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-orange-800 transition-colors shrink-0">
                            Gerar Relat√≥rio (.doc)
                        </button>
                    </form>
                    <p id="report-status" class="mt-3 text-sm font-medium text-orange-700 hidden"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:col-span-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                        <span id="total-activities-count" class="text-5xl font-bold text-orange-600">0</span>
                        <p class="text-gray-600 mt-2 font-medium">Atividades Mapeadas</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                        <span class="text-5xl font-bold text-orange-600">3</span>
                        <p class="text-gray-600 mt-2 font-medium">Pilares de Atua√ß√£o</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                        <span class="text-5xl font-bold text-orange-600" id="total-months-count">0</span>
                        <p class="text-gray-600 mt-2 font-medium">Meses de Atividades</p>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md md:col-span-2 lg:col-span-3">
                        <h3 class="text-lg font-semibold text-center mb-4 text-orange-900">Distribui√ß√£o de Atividades por Pilar</h3>
                        <div class="chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
            </section>

            <section id="capacitacao" class="tab-content hidden space-y-6">
                <header>
                    <h2 class="text-2xl font-bold text-orange-900">üë• Alinhamento e Capacita√ß√£o</h2>
                    <p class="text-gray-600 mt-1">Atividades voltadas para a forma√ß√£o e integra√ß√£o da equipe do projeto. **Clique na data para edit√°-la.**</p>
                </header>
                
                <!-- Formul√°rio de Adi√ß√£o de Atividade de Capacita√ß√£o -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-800 mb-3">Adicionar Nova Atividade de Capacita√ß√£o</h3>
                    <form id="add-capacitacao-form" class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="new-cap-title" placeholder="T√≠tulo da Atividade (Ex: Treinamento SIMLAM)" class="flex-grow p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>
                        <input type="date" id="new-cap-date" class="p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 w-full sm:w-1/3" required>
                        <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors shrink-0">Adicionar</button>
                    </form>
                </div>

                <!-- Lista Din√¢mica de Atividades de Capacita√ß√£o -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-900 mb-4">Registro de Execu√ß√£o</h3>
                    <div id="capacitacao-list" class="space-y-3">
                        <p class="text-gray-500 text-center" id="capacitacao-loading-status">Carregando atividades...</p>
                    </div>
                </div>
            </section>

            <section id="fluxo" class="tab-content hidden space-y-6">
                <header>
                    <h2 class="text-2xl font-bold text-orange-900">‚öôÔ∏è Desenvolvimento do Fluxo Operacional</h2>
                    <p class="text-gray-600 mt-1">Engenharia e formaliza√ß√£o dos processos de trabalho para an√°lise e gest√£o dos cadastros. **Clique e arraste os blocos para editar ou reordenar as etapas.**</p>
                </header>

                <div class="bg-white p-4 rounded-lg shadow-md flex justify-end">
                    <button id="add-flow-step-button" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors text-sm">
                        + Adicionar Nova Etapa
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <h3 class="text-lg font-semibold text-orange-800 mb-6 text-center whitespace-nowrap">Etapas do Fluxo (Arraste para Reordenar)</h3>
                    
                    <div id="flowchart-container" class="flex flex-col md:flex-row items-stretch md:items-center justify-start md:justify-center space-y-4 md:space-y-0 md:space-x-2 min-h-[100px]">
                        <p class="text-gray-500 text-center w-full" id="fluxo-loading-status">Carregando etapas do fluxo...</p>
                    </div>
                </div>
            </section>

            <section id="ti" class="tab-content hidden space-y-6">
                 <header>
                    <h2 class="text-2xl font-bold text-orange-900">üíª TI e Automa√ß√£o</h2>
                    <p class="text-gray-600 mt-1">Painel Kanban para gerenciar demandas e alinhamentos para otimizar as tarefas operacionais. Clique em um cart√£o para visualizar detalhes, editar ou remover.</p>
                </header>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-800 mb-4">Adicionar Nova Demanda de Automa√ß√£o</h3>
                    <form id="add-demand-form" class="flex flex-col gap-2">
                        <input type="text" id="new-demand-title" placeholder="T√≠tulo da Demanda (Ex: API de eDocs)" class="flex-grow p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>
                        <div class="flex flex-col sm:flex-row gap-2">
                             <input type="text" id="new-demand-responsible" placeholder="Respons√°vel (Nome)" class="p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 w-full sm:w-1/2">
                             <input type="text" id="new-demand-description" placeholder="Descri√ß√£o breve ou completa da demanda" class="p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 w-full sm:w-1/2" required>
                        </div>
                        <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Adicionar Demanda</button>
                    </form>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-900 mb-4">Acompanhamento de Demandas (Kanban)</h3>
                    <div id="ti-demands-board" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <div id="col-Demanda" class="bg-gray-100 p-3 rounded-lg">
                            <h4 class="font-bold text-lg text-red-700 mb-3">üìã Demanda (<span data-count="Demanda">0</span>)</h4>
                            <div class="cards-wrapper space-y-3 min-h-[50px]">
                                <p class="text-gray-500 text-center text-sm">Carregando...</p>
                            </div>
                        </div>
                        
                        <div id="col-Em Execu√ß√£o" class="bg-gray-100 p-3 rounded-lg">
                            <h4 class="font-bold text-lg text-yellow-700 mb-3">üõ†Ô∏è Em Execu√ß√£o (<span data-count="Em Execu√ß√£o">0</span>)</h4>
                             <div class="cards-wrapper space-y-3 min-h-[50px]">
                                <p class="text-gray-500 text-center text-sm">Carregando...</p>
                            </div>
                        </div>
                        
                        <div id="col-Conclu√≠da" class="bg-gray-100 p-3 rounded-lg">
                            <h4 class="font-bold text-lg text-green-700 mb-3">‚úÖ Conclu√≠da (<span data-count="Conclu√≠da">0</span>)</h4>
                            <div class="cards-wrapper space-y-3 min-h-[50px]">
                                <p class="text-gray-500 text-center text-sm">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-800 mb-4">Alinhamento e Integra√ß√µes (Foco)</h3>
                    <ul class="space-y-3 text-gray-700 list-disc list-inside">
                        <li>Identifica√ß√£o do contato respons√°vel pelas APIs do eDocs e direcionamento para a TI do Ifes-Cachoeiro.</li>
                        <li>Alinhamento cont√≠nuo com a TI sobre atividades manuais e o roadmap de automa√ß√£o.</li>
                        <li>Cria√ß√£o de diagrama com o fluxo operacional e as atividades da TI.</li>
                    </ul>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal de Detalhes/Edi√ß√£o -->
    <div id="demand-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold text-orange-900 mb-4" id="modal-title-display">Detalhes da Demanda</h3>
            <form id="edit-demand-form" class="space-y-4">
                <input type="hidden" id="modal-demand-id">
                
                <div>
                    <label for="modal-title" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
                    <input type="text" id="modal-title" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>
                </div>

                <div>
                    <label for="modal-description" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                    <textarea id="modal-description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="modal-start-date" class="block text-sm font-medium text-gray-700">Data de In√≠cio</label>
                        <input type="date" id="modal-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="modal-end-date" class="block text-sm font-medium text-gray-700">Data de T√©rmino</label>
                        <input type="date" id="modal-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" disabled>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="modal-responsible" class="block text-sm font-medium text-gray-700">Respons√°vel</label>
                        <input type="text" id="modal-responsible" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="modal-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="modal-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="Demanda">Demanda</option>
                            <option value="Em Execu√ß√£o">Em Execu√ß√£o</option>
                            <option value="Conclu√≠da">Conclu√≠da</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-between pt-4 border-t border-gray-100">
                    <button type="button" id="delete-demand-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Remover</button>
                    <div class="space-x-2">
                        <button type="button" id="close-modal-button" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Fechar</button>
                        <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARI√ÅVEIS GLOBAIS FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- DADOS DO APLICATIVO (Sincronizados pelo Firestore) ---
        let appData = {
            tiDemands: [],
            flowSteps: [],
            capacitacaoActivities: []
        };
        
        // --- FUN√á√ïES AUXILIARES DE DATA E TEXTO ---

        // Fun√ß√£o para obter o nome do m√™s em portugu√™s
        function getMonthName(monthNumber) {
            const monthNames = [
                "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
            ];
            return monthNames[monthNumber - 1];
        }

        // FUN√á√ÉO AUXILIAR PARA PEGAR A DATA DE HOJE (YYYY-MM-DD)
        function getTodayDateFormatted() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // FUN√á√ÉO AUXILIAR DE DATA PARA EXIBI√á√ÉO (DD/MM/YYYY)
        function formatDateDisplay(dateString) {
            if (!dateString) return 'N/A';
            // Garante que √© uma string de data v√°lida (YYYY-MM-DD)
            if (dateString.length !== 10) return dateString; 
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // Firestore Paths (P√∫blico)
        const getCollectionPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        };

        // Refer√™ncias do Modal (TI Kanban)
        const modal = document.getElementById('demand-modal');
        const editForm = document.getElementById('edit-demand-form');
        const closeModalButton = document.getElementById('close-modal-button');
        const deleteDemandButton = document.getElementById('delete-demand-button');
        
        // Refer√™ncias do Filtro
        const filterForm = document.getElementById('report-filter-form');
        const filterMonthSelect = document.getElementById('filter-month');
        const filterYearSelect = document.getElementById('filter-year');
        const reportStatus = document.getElementById('report-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        let tasksChartInstance = null;
        let currentFilter = { month: null, year: null }; 


        // --- L√ìGICA DE INICIALIZA√á√ÉO FIREBASE E LISTENERS ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config est√° faltando. N√£o foi poss√≠vel inicializar o Firestore.");
                loadingOverlay.style.display = 'none';
                return; 
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Habilitar log de debug para Firestore

                // 1. Autentica√ß√£o
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch(e) {
                                console.error("Erro na autentica√ß√£o:", e);
                            }
                        }
                        
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                        isAuthReady = true;
                        unsubscribe(); 
                        resolve();
                    });
                });
                console.log("Firebase inicializado e usu√°rio autenticado:", userId);

                // 2. Iniciar Listeners em Tempo Real
                setupRealtimeListeners();
                
            } catch (error) {
                console.error("Erro durante a inicializa√ß√£o do Firebase:", error);
                loadingOverlay.style.display = 'none';
            }
        }

        function setupRealtimeListeners() {
            if (!db || !isAuthReady) return;

            // 1. TI Demands Listener (Kanban)
            onSnapshot(collection(db, getCollectionPath('tiDemands')), (snapshot) => {
                appData.tiDemands = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTIDemands();
                updateDashboard();
            }, (error) => {
                console.error("Erro ao ouvir TI Demands:", error);
            });

            // 2. Capacita√ß√£o Listener
            onSnapshot(collection(db, getCollectionPath('capacitacao')), (snapshot) => {
                appData.capacitacaoActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('capacitacao-loading-status').classList.add('hidden');
                renderCapacitacaoActivities();
                updateDashboard();
            }, (error) => {
                console.error("Erro ao ouvir Capacita√ß√£o:", error);
            });

            // 3. Flow Steps Listener (Fluxo Operacional)
            const flowQuery = query(collection(db, getCollectionPath('fluxo')));
            onSnapshot(flowQuery, (snapshot) => {
                // Fetch all documents and sort them by the 'order' field in memory (evitar index issues)
                const fetchedSteps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                appData.flowSteps = fetchedSteps.sort((a, b) => (a.order || 0) - (b.order || 0));
                document.getElementById('fluxo-loading-status').classList.add('hidden');
                renderFlowSteps();
                updateDashboard();
                loadingOverlay.style.display = 'none';
            }, (error) => {
                console.error("Erro ao ouvir Fluxo Steps:", error);
                loadingOverlay.style.display = 'none';
            });
        }


        // --- L√ìGICA DE FILTRO E EXPORTA√á√ÉO (.DOC) ---

        const months = [
            { value: 9, label: "Setembro" },
            { value: 10, label: "Outubro" },
            { value: 11, label: "Novembro" },
            { value: 12, label: "Dezembro" }
        ];
        const years = [2024, 2025]; 

        function populateFilterSelectors() {
            // M√™s
            filterMonthSelect.innerHTML = '<option value="" disabled selected>Selecione o M√™s</option>';
            months.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.label;
                filterMonthSelect.appendChild(option);
            });

            // Ano
            filterYearSelect.innerHTML = '<option value="" disabled selected>Selecione o Ano</option>';
            years.forEach(y => {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                filterYearSelect.appendChild(option);
            });

            // Define Outubro/2025 como padr√£o
            filterMonthSelect.value = 10; 
            filterYearSelect.value = 2025;
            filterActivities(10, 2025); // Filtra inicial para Dashboard
        }

        function filterActivities(month, year) {
            currentFilter = { month, year };
            
            if (!month || !year) {
                reportStatus.textContent = 'Selecione M√™s e Ano para gerar o relat√≥rio.';
                reportStatus.classList.remove('hidden', 'text-green-700', 'text-red-700');
                return { filteredCapacitacao: appData.capacitacaoActivities, filteredTIDemands: appData.tiDemands }; 
            }

            const targetMonth = parseInt(month);
            const targetYear = parseInt(year);

            // 1. FILTRO DE CAPACITA√á√ÉO (pela data de execu√ß√£o)
            const filteredCapacitacao = appData.capacitacaoActivities.filter(activity => {
                if (!activity.date) return false;
                const activityDate = new Date(activity.date + 'T00:00:00'); 
                return activityDate.getMonth() + 1 === targetMonth && activityDate.getFullYear() === targetYear;
            });

            // 2. FILTRO DE TI (pela data de in√≠cio, fim ou se o per√≠odo cobre o m√™s)
            const filteredTIDemands = appData.tiDemands.filter(demand => {
                const start = new Date(demand.startDate + 'T00:00:00');
                const end = demand.endDate ? new Date(demand.endDate + 'T00:00:00') : new Date(getTodayDateFormatted() + 'T00:00:00'); 
                
                const targetStart = new Date(targetYear, targetMonth - 1, 1); 
                const targetEnd = new Date(targetYear, targetMonth, 0); 

                // Crit√©rio: A demanda est√° ativa no m√™s
                return start <= targetEnd && end >= targetStart;
            });
            
            const totalFiltered = filteredCapacitacao.length + appData.flowSteps.length + filteredTIDemands.length;

            reportStatus.textContent = `Filtro aplicado: ${getMonthName(targetMonth)}/${targetYear}. Total de atividades no filtro: ${totalFiltered}.`;
            reportStatus.classList.remove('hidden', 'text-red-700');
            reportStatus.classList.add('text-green-700');

            return { month: targetMonth, year: targetYear, filteredCapacitacao, filteredTIDemands };
        }

        // Fun√ß√£o para gerar e baixar o arquivo .doc
        function generateDocxReport(month, year, filteredCapacitacao, flowAct, filteredTIDemands) {
            const monthName = getMonthName(month);
            const dateTitle = `${monthName} de ${year}`;
            const completedCapacitacaoCount = filteredCapacitacao.filter(a => a.completed).length;

            // ... (HTML Structure for the Word Document remains the same) ...
            let reportContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>Relat√≥rio CNPq - IntegraCAR - ${dateTitle}</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 40px; }
                        h1 { font-size: 18pt; font-weight: bold; text-align: center; margin-bottom: 5px; }
                        h2 { font-size: 14pt; font-weight: bold; margin-top: 25px; margin-bottom: 10px; color: #000; }
                        h3 { font-size: 12pt; font-weight: bold; margin-top: 15px; margin-bottom: 8px; color: #555; }
                        p { font-size: 11pt; margin-bottom: 15px; text-align: justify; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 10pt;}
                        th { background-color: #f0f0f0; color: #333; font-weight: bold; }
                        .status-concluida { color: #059669; font-weight: bold; }
                        .status-demanda { color: #DC2626; font-weight: bold; }
                        .status-em-execucao { color: #D97706; font-weight: bold; }
                    </style>
                </head>
                <body>
                    
                    <!-- T√çTULO E AUTORES -->
                    <div style="text-align: center;">
                        <h1>Relat√≥rio de Progresso e Mapeamento de Atividades do Projeto IntegraCAR</h1>
                        <p style="font-size: 12pt; margin-top: 0; margin-bottom: 5px;">Relat√≥rio CNPq - Per√≠odo de ${dateTitle}</p>
                        <p style="font-size: 11pt; font-style: italic; margin-bottom: 40px; color: #555;">Autor: Equipe de Projeto IntegraCAR | Data: ${formatDateDisplay(getTodayDateFormatted()).replace(/\//g, '-')}</p>
                    </div>
                    
                    <!-- 2. METODOLOGIA (FLUXO OPERACIONAL) -->
                    <h2>1. METODOLOGIA: O FLUXO OPERACIONAL DE AN√ÅLISE</h2>
                    <p>
                        A metodologia de trabalho √© definida pela sequ√™ncia de etapas formalizadas para a an√°lise dos documentos e mapas do CAR, garantindo a rastreabilidade e a qualidade do processo. O fluxo operacional √© composto por ${flowAct.length} etapas, representando o processo padr√£o de an√°lise e gest√£o dos cadastros:
                    </p>
                    
                    <!-- LISTA ORDENADA DO FLUXO -->
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        ${flowAct.map((f, index) => `
                            <li style="font-size: 11pt; margin-bottom: 8px;">
                                <strong>${f.title}:</strong> ${f.desc}
                            </li>
                        `).join('')}
                        ${flowAct.length === 0 ? '<p style="font-size: 11pt; font-style: italic;">Nenhuma etapa de fluxo operacional definida.</p>' : ''}
                    </ol>

                    <!-- 3. RESULTADOS E DISCUSS√ÉO -->
                    <h2>2. RESULTADOS E DISCUSS√ÉO</h2>
                    <p>
                        Os resultados no per√≠odo concentraram-se na execu√ß√£o das a√ß√µes de capacita√ß√£o, na homologa√ß√£o do fluxo metodol√≥gico e no avan√ßo das demandas de automa√ß√£o para a TI.
                    </p>
                    
                    <!-- SUB-SE√á√ÉO CAPACITA√á√ÉO -->
                    <h3>2.1. A√ß√µes de Alinhamento e Capacita√ß√£o (Per√≠odo: ${dateTitle})</h3>
                    <table>
                        <thead>
                            <tr><th>Atividade</th><th>Data de Execu√ß√£o</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            ${filteredCapacitacao.map(a => `
                                <tr>
                                    <td>${a.title}</td>
                                    <td>${formatDateDisplay(a.date)}</td>
                                    <td>${a.completed ? '<span class="status-concluida">Conclu√≠da</span>' : 'Pendente'}</td>
                                </tr>
                            `).join('')}
                            ${filteredCapacitacao.length === 0 ? '<tr><td colspan="3">Nenhuma atividade de Capacita√ß√£o registrada neste per√≠odo.</td></tr>' : ''}
                        </tbody>
                    </table>
                    
                    <!-- SUB-SE√á√ÉO TI -->
                    <h3>2.2. Tecnologia e Automa√ß√£o (Demandas Ativas ou Conclu√≠das no Per√≠odo: ${dateTitle})</h3>
                    <table>
                        <thead>
                            <tr><th>Demanda</th><th>Respons√°vel</th><th>Status</th><th>In√≠cio</th><th>T√©rmino</th></tr>
                        </thead>
                        <tbody>
                            ${filteredTIDemands.map(d => `
                                <tr>
                                    <td>${d.title}</td>
                                    <td>${d.responsible || 'N/A'}</td>
                                    <td class="status-${d.status.toLowerCase().replace(/ /g, '-')}">${d.status}</td>
                                    <td>${formatDateDisplay(d.startDate)}</td>
                                    <td>${formatDateDisplay(d.endDate)}</td>
                                </tr>
                            `).join('')}
                            ${filteredTIDemands.length === 0 ? '<tr><td colspan="5">Nenhuma demanda de TI & Automa√ß√£o ativa neste per√≠odo.</td></tr>' : ''}
                        </tbody>
                    </table>

                    <!-- 4. CONCLUS√ÉO -->
                    <h2>3. CONCLUS√ÉO</h2>
                    <p>
                        O projeto IntegraCAR demonstrou progresso significativo no per√≠odo, com a consolida√ß√£o da metodologia de trabalho (Se√ß√£o 1) e o avan√ßo das atividades de capacita√ß√£o e tecnol√≥gica (Se√ß√£o 2). A equipe atingiu o √≠ndice de ${completedCapacitacaoCount}/${filteredCapacitacao.length} atividades de forma√ß√£o conclu√≠das e direcionou as demandas necess√°rias para automa√ß√£o. O pr√≥ximo per√≠odo de relat√≥rio focar√° na homologa√ß√£o das solu√ß√µes de TI e na aplica√ß√£o do fluxo operacional na an√°lise em lote dos cadastros para cumprir as metas estabelecidas.
                    </p>

                </body>
                </html>
            `;

            // Download Logic 
            const fileName = `Relatorio_CNPq_IntegraCAR_${monthName}_${year}.doc`;
            const mimeType = 'application/msword';
            
            const blob = new Blob([reportContent], { type: mimeType });

            const a = document.createElement('a');
            const url = URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            reportStatus.textContent += ' O download do relat√≥rio (.doc) foi iniciado no formato Artigo CNPq.';
        }


        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const month = filterMonthSelect.value;
            const year = filterYearSelect.value;
            
            if (!month || !year) {
                filterActivities(month, year); 
                return;
            }

            const { month: filteredMonth, year: filteredYear, filteredCapacitacao, filteredTIDemands } = filterActivities(month, year);
            
            generateDocxReport(filteredMonth, filteredYear, filteredCapacitacao, appData.flowSteps, filteredTIDemands);
        });

        // --- FUN√á√ïES GERAIS DE ATUALIZA√á√ÉO DO PAINEL ---
        function updateDashboard() {
            
            const currentChartData = {
                capacitacao: appData.capacitacaoActivities.length,
                fluxo: appData.flowSteps.length,
                ti: appData.tiDemands.length
            };

            const totalActivities = currentChartData.capacitacao + currentChartData.fluxo + currentChartData.ti;
            document.getElementById('total-activities-count').textContent = totalActivities;
            
            // Contar meses √∫nicos em Capacita√ß√£o
            const dates = appData.capacitacaoActivities.map(a => a.date);
            const uniqueMonths = new Set(dates.map(d => d.substring(0, 7))); // YYYY-MM
            document.getElementById('total-months-count').textContent = uniqueMonths.size;


            if (tasksChartInstance) {
                tasksChartInstance.data.datasets[0].data = Object.values(currentChartData);
                tasksChartInstance.update();
            }
        }
        
        // --- FUN√á√ïES DE CAPACITA√á√ÉO (CRUD COM FIRESTORE) ---
        
        async function updateCapacitacaoDate(docId, newDate) {
            if (!db || !isAuthReady) { console.error("Firestore n√£o est√° pronto."); return; }
            try {
                const docRef = doc(db, getCollectionPath('capacitacao'), docId);
                const isCompleted = new Date(newDate) <= new Date(getTodayDateFormatted());
                
                await updateDoc(docRef, { 
                    date: newDate, 
                    completed: isCompleted,
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Erro ao atualizar a data da capacita√ß√£o:", error);
            }
        }


        function renderCapacitacaoActivities() {
            const listContainer = document.getElementById('capacitacao-list');
            if (!listContainer) return;
            
            // Remove o status de loading/vazio se houver dados
            if (appData.capacitacaoActivities.length === 0) {
                 listContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma atividade de capacita√ß√£o registrada.</p>';
                 return;
            }
            listContainer.innerHTML = '';
            
            // Ordena por data (mais recente primeiro)
            const sortedActivities = [...appData.capacitacaoActivities].sort((a, b) => {
                // Converte para Date e trata datas nulas ou inv√°lidas
                const dateA = new Date(a.date + 'T00:00:00');
                const dateB = new Date(b.date + 'T00:00:00');
                return dateB.getTime() - dateA.getTime();
            });

            sortedActivities.forEach(activity => {
                const dateDisplay = formatDateDisplay(activity.date);
                const statusIcon = activity.completed ? '‚úîÔ∏è' : '‚è≥';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'capacitacao-list-item flex items-start justify-between p-3 rounded-lg border border-orange-200 transition-colors hover:bg-orange-50 relative';
                itemDiv.setAttribute('data-id', activity.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn text-gray-400 hover:text-red-600 p-1 rounded-full ml-3 shrink-0 opacity-0 transition-opacity absolute top-1 right-1';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'Remover Atividade';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('Tem certeza que deseja remover esta atividade?')) {
                         deleteCapacitacaoActivity(activity.id);
                    }
                };

                itemDiv.innerHTML = `
                    <div class="flex items-start flex-1 pr-10">
                        <span class="text-lg mr-3 shrink-0">${statusIcon}</span>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${activity.title}</p>
                            <div class="flex items-center">
                                <span class="text-xs text-gray-500 mt-0.5 mr-2">Execu√ß√£o:</span>
                                <!-- DISPLAY DA DATA EDIT√ÅVEL -->
                                <span class="font-semibold text-orange-700 cursor-pointer hover:bg-orange-200 px-1 py-0.5 rounded transition-all inline-block" 
                                    data-type="display" 
                                    data-id="${activity.id}"
                                    title="Clique para editar a data">
                                    ${dateDisplay}
                                </span>
                                <input type="date" 
                                    class="hidden p-1 border border-orange-400 rounded-md text-xs w-28" 
                                    data-type="input" 
                                    data-id="${activity.id}"
                                    value="${activity.date}">
                            </div>
                        </div>
                    </div>
                `;
                itemDiv.appendChild(deleteBtn);
                listContainer.appendChild(itemDiv);
            });
            
            // Adiciona listeners para edi√ß√£o da data (persiste o click-to-edit)
            listContainer.querySelectorAll('[data-type="display"]').forEach(span => {
                span.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const input = listContainer.querySelector(`input[data-id="${id}"][data-type="input"]`);
                    this.classList.add('hidden');
                    input.classList.remove('hidden');
                    input.focus();
                });
            });

            listContainer.querySelectorAll('[data-type="input"]').forEach(input => {
                // A√ß√£o de salvar ao perder o foco (blur)
                input.addEventListener('blur', async function() {
                    const id = this.getAttribute('data-id');
                    const display = listContainer.querySelector(`span[data-id="${id}"][data-type="display"]`);
                    
                    this.classList.add('hidden');
                    display.classList.remove('hidden');
                    
                    const activity = appData.capacitacaoActivities.find(a => a.id === id);
                    if (activity && activity.date !== this.value) {
                        await updateCapacitacaoDate(id, this.value);
                    } else {
                        // Se n√£o mudou, apenas atualiza o display (caso a blur foi causada por um clique na mesma data)
                        display.textContent = formatDateDisplay(this.value);
                    }
                });

                // A√ß√£o de salvar ao pressionar Enter
                input.addEventListener('keydown', function(e) {
                     if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        const addCapacitacaoForm = document.getElementById('add-capacitacao-form');
        addCapacitacaoForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!db || !isAuthReady) { alert("Firestore n√£o est√° pronto. Tente novamente."); return; }

            const titleInput = document.getElementById('new-cap-title');
            const dateInput = document.getElementById('new-cap-date');
            
            const newTitle = titleInput.value.trim();
            const newDate = dateInput.value;

            if (newTitle && newDate) {
                try {
                    const isCompleted = new Date(newDate) <= new Date(getTodayDateFormatted());
                    await addDoc(collection(db, getCollectionPath('capacitacao')), {
                        title: newTitle,
                        date: newDate,
                        completed: isCompleted,
                        createdAt: serverTimestamp()
                    });
                    
                    titleInput.value = '';
                    dateInput.value = ''; 
                    // onSnapshot renderiza e atualiza o dashboard
                } catch (error) {
                    console.error("Erro ao adicionar atividade de capacita√ß√£o:", error);
                }
            }
        });

        async function deleteCapacitacaoActivity(docId) {
            if (!db || !isAuthReady) { console.error("Firestore n√£o est√° pronto."); return; }
            try {
                await deleteDoc(doc(db, getCollectionPath('capacitacao'), docId));
                // onSnapshot renderiza e atualiza o dashboard
            } catch (error) {
                console.error("Erro ao deletar atividade de capacita√ß√£o:", error);
            }
        }

        // --- FUN√á√ïES DE FLUXO OPERACIONAL (CRUD E DRAG/DROP COM FIRESTORE) ---

        function renderFlowSteps() {
            const container = document.getElementById('flowchart-container');
            if (!container) return;
            
            // Se o Fluxo est√° vazio, mostra mensagem e esconde o bot√£o de loading
             if (appData.flowSteps.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center w-full">Nenhuma etapa do fluxo operacional definida. Adicione a primeira!</p>';
                 return;
            }
            container.innerHTML = ''; // Limpa o container
            
            appData.flowSteps.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'flowchart-step text-center bg-orange-100 p-3 rounded-lg border border-orange-200 w-full md:flex-1 shrink-0 h-full relative group';
                stepDiv.setAttribute('data-id', step.id);
                stepDiv.setAttribute('draggable', 'true');
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'absolute top-1 right-1 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded-full bg-orange-100/70 z-10 text-xl leading-none';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = 'Remover Etapa';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    if (confirm('Tem certeza que deseja remover esta etapa do fluxo?')) {
                         deleteFlowStep(step.id);
                    }
                };
                
                stepDiv.innerHTML = `
                    <div class="text-lg mb-1 font-semibold">${index + 1}</div>
                    <h4 class="font-bold text-sm mb-1 edit-title" contenteditable="true" data-id="${step.id}">${step.title}</h4>
                    <p class="text-xs text-gray-600 mt-1 edit-desc" contenteditable="true" data-id="${step.id}">${step.desc}</p>
                `;
                stepDiv.appendChild(deleteBtn);
                
                container.appendChild(stepDiv);
                
                if (index < appData.flowSteps.length - 1) {
                    const arrowDiv = document.createElement('div');
                    arrowDiv.className = 'flowchart-arrow self-center hidden md:block';
                    arrowDiv.innerHTML = '‚Üí';
                    container.appendChild(arrowDiv);
                }
            });
            
            addFlowListeners();
        }

        function addFlowListeners() {
            document.querySelectorAll('.flowchart-step').forEach(step => {
                step.addEventListener('dragstart', handleDragStart);
                step.addEventListener('dragover', handleDragOver);
                step.addEventListener('dragleave', handleDragLeave);
                step.addEventListener('drop', handleDrop);
                step.addEventListener('dragend', handleDragEnd);
            });
            
            document.querySelectorAll('.edit-title, .edit-desc').forEach(el => {
                el.addEventListener('blur', updateFlowStep);
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        el.blur();
                    }
                });
            });
        }
        
        // --- DRAG AND DROP (Reorder logic) ---
        
        let draggingStep = null;

        function handleDragStart(e) {
            draggingStep = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
            setTimeout(() => this.classList.add('opacity-40', 'shadow-xl'), 0); 
        }

        function handleDragOver(e) {
            e.preventDefault();
            const stepElement = this;
            if (stepElement.classList.contains('flowchart-step') && stepElement !== draggingStep) {
                const rect = stepElement.getBoundingClientRect();
                const midpoint = (rect.left + rect.right) / 2;
                
                stepElement.style.borderLeft = '';
                stepElement.style.borderRight = '';
                
                if (e.clientX < midpoint) {
                    stepElement.style.borderLeft = '4px solid #c2410c'; 
                } else {
                    stepElement.style.borderRight = '4px solid #c2410c'; 
                }
            }
        }

        function handleDragLeave() {
            this.style.borderLeft = '';
            this.style.borderRight = '';
        }

        async function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            this.style.borderLeft = '';
            this.style.borderRight = '';

            if (draggingStep && draggingStep !== this && db && isAuthReady) {
                const draggedId = draggingStep.getAttribute('data-id');
                const targetId = this.getAttribute('data-id');

                const draggedIndex = appData.flowSteps.findIndex(s => s.id === draggedId);
                
                if (draggedIndex === -1) return;

                const [movedStep] = appData.flowSteps.splice(draggedIndex, 1);
                
                const currentTargetIndex = appData.flowSteps.findIndex(s => s.id === targetId);

                const rect = this.getBoundingClientRect();
                const midpoint = (rect.left + rect.right) / 2;
                
                if (e.clientX > midpoint) {
                     appData.flowSteps.splice(currentTargetIndex + 1, 0, movedStep);
                } else {
                     appData.flowSteps.splice(currentTargetIndex, 0, movedStep);
                }
                
                // BATCH UPDATE: Atualiza o campo 'order' para todos os documentos na nova ordem.
                const batch = writeBatch(db);
                appData.flowSteps.forEach((step, index) => {
                    const stepRef = doc(db, getCollectionPath('fluxo'), step.id);
                    batch.update(stepRef, { order: index, updatedAt: serverTimestamp() });
                });

                try {
                    await batch.commit();
                    // onSnapshot ir√° lidar com a renderiza√ß√£o.
                } catch (error) {
                    console.error("Erro ao reordenar o fluxo:", error);
                }
            }
        }

        function handleDragEnd() {
            this.classList.remove('opacity-40', 'shadow-xl');
            this.style.borderLeft = '';
            this.style.borderRight = '';
            draggingStep = null;
        }
        
        // --- FLUXO CRUD FIRESTORE ---

        async function updateFlowStep(e) {
            if (!db || !isAuthReady) { console.error("Firestore n√£o est√° pronto."); return; }
            const element = e.target;
            const docId = element.getAttribute('data-id');
            
            const updatePayload = {
                updatedAt: serverTimestamp()
            };
            
            const value = element.textContent.trim();
            
            if (element.classList.contains('edit-title')) {
                updatePayload.title = value || "T√≠tulo Vazio";
            } else if (element.classList.contains('edit-desc')) {
                updatePayload.desc = value;
            }

            try {
                await updateDoc(doc(db, getCollectionPath('fluxo'), docId), updatePayload);
            } catch (error) {
                console.error("Erro ao atualizar etapa do fluxo:", error);
            }
        }

        document.getElementById('add-flow-step-button').addEventListener('click', async () => {
            if (!db || !isAuthReady) { alert("Firestore n√£o est√° pronto. Tente novamente."); return; }
            try {
                await addDoc(collection(db, getCollectionPath('fluxo')), {
                    title: "Nova Etapa",
                    desc: "Adicione uma descri√ß√£o para esta etapa.",
                    order: appData.flowSteps.length, 
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Erro ao adicionar etapa do fluxo:", error);
            }
        });

        async function deleteFlowStep(docId) {
            if (!db || !isAuthReady) { console.error("Firestore n√£o est√° pronto."); return; }
            try {
                await deleteDoc(doc(db, getCollectionPath('fluxo'), docId));
                // onSnapshot lida com a re-renderiza√ß√£o
            } catch (error) {
                console.error("Erro ao deletar etapa do fluxo:", error);
            }
        }
        
        // --- FUN√á√ïES KANBAN (TI) E RENDERIZA√á√ÉO ---
        
        function renderTIDemands() {
            const boardColumns = {
                "Demanda": document.getElementById('col-Demanda').querySelector('.cards-wrapper'),
                "Em Execu√ß√£o": document.getElementById('col-Em Execu√ß√£o').querySelector('.cards-wrapper'),
                "Conclu√≠da": document.getElementById('col-Conclu√≠da').querySelector('.cards-wrapper')
            };

            let demandCounts = { "Demanda": 0, "Em Execu√ß√£o": 0, "Conclu√≠da": 0 };
            Object.values(boardColumns).forEach(col => { col.innerHTML = ''; });

            // Se n√£o h√° dados, mostra a mensagem de vazio
            if (appData.tiDemands.length === 0) {
                 Object.values(boardColumns).forEach(col => {
                    col.innerHTML = '<p class="text-gray-500 text-center text-sm">Nenhuma demanda registrada.</p>';
                 });
                 return;
            }


            appData.tiDemands.forEach(demand => {
                const descPreview = demand.desc.substring(0, 90) + (demand.desc.length > 90 ? '...' : '');
                const formattedStart = formatDateDisplay(demand.startDate);
                const formattedEnd = formatDateDisplay(demand.endDate);
                
                const itemHtml = `
                    <div data-id="${demand.id}" class="kanban-card bg-white p-3 rounded-lg shadow-sm border border-orange-200 cursor-pointer transition-shadow duration-150">
                        <h5 class="font-bold text-sm text-orange-900">${demand.title}</h5>
                        <p class="text-xs text-gray-500 mt-1 mb-2">${descPreview}</p>
                        <p class="text-xs font-medium text-gray-700">In√≠cio: <span class="font-semibold">${formattedStart}</span></p>
                        <p class="text-xs font-medium text-gray-700">T√©rmino: <span class="font-semibold">${formattedEnd}</span></p>
                        <p class="text-xs font-medium text-gray-700">Resp: <span class="font-semibold">${demand.responsible || 'N√£o Definido'}</span></p>
                    </div>`;
                
                const colWrapper = boardColumns[demand.status];
                if (colWrapper) {
                     // Se n√£o √© a mensagem de loading/vazio, pode adicionar o HTML
                     if (colWrapper.querySelector('p.text-gray-500')) {
                        colWrapper.innerHTML = ''; 
                     }
                     colWrapper.insertAdjacentHTML('beforeend', itemHtml);
                     demandCounts[demand.status]++;
                }
            });
            
            document.querySelectorAll(`#ti-demands-board [data-count]`).forEach(countEl => {
                const status = countEl.closest('[id^="col-"]').id.replace('col-', '');
                countEl.textContent = demandCounts[status] || 0;
            });
            
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = card.getAttribute('data-id'); // ID √© string do Firestore
                    openDemandModal(id);
                });
            });
        }
        
        function toggleEndDateInput(status) {
            const endDateInput = document.getElementById('modal-end-date');
            if (status === 'Conclu√≠da') {
                endDateInput.disabled = false;
                if (!endDateInput.value) {
                     endDateInput.value = getTodayDateFormatted();
                }
            } else {
                endDateInput.disabled = true;
                // N√£o limpa o valor aqui para o caso de o usu√°rio mudar de ideia
            }
        }

        // FUN√á√ïES DO MODAL (TI Kanban)
        function openDemandModal(id) {
            const demand = appData.tiDemands.find(d => d.id === id);
            if (!demand) return;

            document.getElementById('modal-demand-id').value = demand.id;
            document.getElementById('modal-title').value = demand.title;
            document.getElementById('modal-description').value = demand.desc;
            document.getElementById('modal-responsible').value = demand.responsible || '';
            document.getElementById('modal-status').value = demand.status;
            
            document.getElementById('modal-start-date').value = demand.startDate || '';
            document.getElementById('modal-end-date').value = demand.endDate || '';

            toggleEndDateInput(demand.status);

            document.getElementById('modal-title-display').textContent = demand.title;

            modal.classList.remove('invisible', 'opacity-0');
            modal.classList.add('visible', 'opacity-100');
        }

        function closeDemandModal() {
            modal.classList.remove('visible', 'opacity-100');
            modal.classList.add('invisible', 'opacity-0');
        }

        // EVENTOS DO MODAL (TI Kanban)
        closeModalButton.addEventListener('click', closeDemandModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeDemandModal(); 
        });

        document.getElementById('modal-status').addEventListener('change', function(e) {
            toggleEndDateInput(e.target.value);
        });

        editForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!db || !isAuthReady) { alert("Firestore n√£o est√° pronto. Tente novamente."); return; }

            const id = document.getElementById('modal-demand-id').value;
            const newStatus = document.getElementById('modal-status').value;
            const newStartDate = document.getElementById('modal-start-date').value; 
            let newEndDate = document.getElementById('modal-end-date').value;

            if (newStatus !== 'Conclu√≠da') {
                newEndDate = ''; // Limpa a data de t√©rmino se o status n√£o for conclu√≠do
            }

            const updatePayload = {
                title: document.getElementById('modal-title').value.trim(),
                desc: document.getElementById('modal-description').value.trim(),
                responsible: document.getElementById('modal-responsible').value.trim(),
                status: newStatus,
                startDate: newStartDate, 
                endDate: newEndDate,
                updatedAt: serverTimestamp()
            };

            try {
                await updateDoc(doc(db, getCollectionPath('tiDemands'), id), updatePayload);
                closeDemandModal();
            } catch (error) {
                console.error("Erro ao atualizar demanda:", error);
            }
        });

        deleteDemandButton.addEventListener('click', async function() {
            if (!db || !isAuthReady) { alert("Firestore n√£o est√° pronto. Tente novamente."); return; }
            const id = document.getElementById('modal-demand-id').value;
            if (confirm('Tem certeza que deseja remover esta demanda de TI?')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('tiDemands'), id));
                    closeDemandModal();
                } catch (error) {
                    console.error("Erro ao deletar demanda:", error);
                }
            }
        });

        // L√ìGICA DO FORMUL√ÅRIO DE ADI√á√ÉO (TI Kanban)
        document.getElementById('add-demand-form').addEventListener('submit', async function (e) {
            e.preventDefault();
             if (!db || !isAuthReady) { alert("Firestore n√£o est√° pronto. Tente novamente."); return; }

            const titleInput = document.getElementById('new-demand-title');
            const responsibleInput = document.getElementById('new-demand-responsible');
            const descriptionInput = document.getElementById('new-demand-description');
            
            const newTitle = titleInput.value.trim();
            const newResponsible = responsibleInput.value.trim() || 'Aguardando Defini√ß√£o';
            const newDescription = descriptionInput.value.trim();

            if (newTitle && newDescription) {
                try {
                    await addDoc(collection(db, getCollectionPath('tiDemands')), { 
                        title: newTitle, 
                        desc: newDescription, 
                        status: "Demanda", 
                        responsible: newResponsible,
                        startDate: getTodayDateFormatted(), 
                        endDate: '',   
                        createdAt: serverTimestamp()
                    });
                    
                    titleInput.value = '';
                    responsibleInput.value = '';
                    descriptionInput.value = '';
                } catch (error) {
                    console.error("Erro ao adicionar demanda:", error);
                }
            }
        });
        
        // L√ìGICA DAS ABAS
        const tabs = document.querySelectorAll('nav button');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                contents.forEach(content => {
                    content.id === target ? content.classList.remove('hidden') : content.classList.add('hidden');
                });
            });
        });

        // INICIALIZA√á√ÉO DO GR√ÅFICO 
        const initializeChart = (data) => {
            if (tasksChartInstance) {
                tasksChartInstance.destroy();
            }
            const taskChartData = {
                labels: ['Capacita√ß√£o', 'Fluxo Operacional', 'TI & Automa√ß√£o'],
                datasets: [{
                    label: 'Atividades por Pilar',
                    data: Object.values(data),
                    backgroundColor: ['#FBBF24', '#F97316', '#92400E'], 
                    borderColor: '#fff7ed',
                    borderWidth: 3,
                    hoverOffset: 4
                }]
            };
            tasksChartInstance = new Chart(document.getElementById('tasksChart'), {
                type: 'doughnut',
                data: taskChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { family: "'Inter', sans-serif" } } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += context.parsed + ' atividades'; } return label; } } },
                    cutout: '60%'
                }
            });
        }

        // RENDERIZA√á√ÉO INICIAL E BOOTSTRAP
        window.onload = function() {
            initializeFirebase();
            populateFilterSelectors();
            
            // Inicializa o gr√°fico com 0 para que ele exista
            initializeChart({ capacitacao: 0, fluxo: 0, ti: 0 }); 
        }
    </script>
</body>
</html>
