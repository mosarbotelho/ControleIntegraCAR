<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Atividades - Projeto IntegraCAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Terra Cota & Creme -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff7ed;
        }
        .tab-active {
            border-color: #c2410c;
            color: #c2410c;
            font-weight: 600;
        }
        .flowchart-step {
            transition: all 0.3s ease;
            cursor: grab; /* Indica que √© arrast√°vel */
        }
        .flowchart-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flowchart-arrow {
            font-size: 2.5rem;
            line-height: 1;
            color: #d1d5db;
            padding: 0 0.5rem;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .kanban-card:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Custom class for the responsive chart container height */
        .chart-container {
            position: relative; 
            width: 100%; 
            height: 300px; /* Base height */
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }
        /* Estilo para desabilitar o input de forma visual mais clara */
        #modal-end-date:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        /* Estilo para campos edit√°veis inline */
        .edit-title, .edit-desc {
            min-height: 1.25rem;
            outline: none;
            border-bottom: 1px solid transparent;
            cursor: text;
        }
        .edit-title:focus, .edit-desc:focus {
            border-bottom-color: #c2410c;
            background-color: #fee2e2;
            padding-bottom: 1px;
        }
        .capacitacao-list-item:hover .delete-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-orange-900">Relat√≥rio Interativo de Atividades</h1>
            <p class="text-lg text-orange-800 mt-1">Projeto IntegraCAR</p>
        </header>

        <nav class="flex justify-center border-b border-orange-200 mb-8 flex-wrap">
            <button data-tab="overview" class="py-4 px-6 text-sm sm:text-base border-b-2 tab-active">Vis√£o Geral</button>
            <button data-tab="capacitacao" class="py-4 px-6 text-sm sm:text-base border-b-2 border-transparent hover:border-orange-300 transition-colors">Capacita√ß√£o</button>
            <button data-tab="fluxo" class="py-4 px-6 text-sm sm:text-base border-b-2 border-transparent hover:border-orange-300 transition-colors">Fluxo Operacional</button>
            <button data-tab="ti" class="py-4 px-6 text-sm sm:text-base border-b-2 border-transparent hover:border-orange-300 transition-colors">TI & Automa√ß√£o</button>
        </nav>

        <main id="content">
            
            <section id="overview" class="tab-content space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-orange-900 mb-2">Vis√£o Geral do Projeto</h2>
                    <p class="text-gray-600">Este painel resume as principais frentes de trabalho. A fase inicial concentrou-se na estrutura√ß√£o f√≠sica e capacita√ß√£o da equipe, evoluindo para o desenho de processos e a defini√ß√£o de requisitos tecnol√≥gicos cruciais para a automa√ß√£o das an√°lises do CAR. O total de atividades √© baseado nos pilares Capacita√ß√£o, Fluxo Operacional e TI & Automa√ß√£o.</p>
                </div>
                
                <!-- BLOCO DE FILTRO DE RELAT√ìRIO -->
                <div class="bg-orange-50 p-6 rounded-xl shadow-inner border border-orange-200">
                    <h3 class="text-xl font-bold text-orange-900 mb-4 flex items-center">
                        <span class="mr-2">üìÖ</span> Relat√≥rio Mensal de Atividades e Exporta√ß√£o
                    </h3>
                    <form id="report-filter-form" class="flex flex-col sm:flex-row gap-3 items-end">
                        <div class="flex-1 w-full sm:w-auto">
                            <label for="filter-month" class="block text-sm font-medium text-gray-700 mb-1">M√™s</label>
                            <select id="filter-month" class="w-full p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 bg-white" required>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="flex-1 w-full sm:w-auto">
                            <label for="filter-year" class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
                            <select id="filter-year" class="w-full p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 bg-white" required>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-orange-800 transition-colors shrink-0">
                            Gerar Relat√≥rio (.doc)
                        </button>
                    </form>
                    <p id="report-status" class="mt-3 text-sm font-medium text-orange-700 hidden"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                        <span id="total-activities-count" class="text-5xl font-bold text-orange-600">0</span>
                        <p class="text-gray-600 mt-2 font-medium">Atividades Mapeadas</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                        <span class="text-5xl font-bold text-orange-600">3</span>
                        <p class="text-gray-600 mt-2 font-medium">Pilares de Atua√ß√£o</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center text-center">
                        <span class="text-5xl font-bold text-orange-600">2</span>
                        <p class="text-gray-600 mt-2 font-medium">Meses de Atividades</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md md:col-span-2 lg:col-span-3">
                        <h3 class="text-lg font-semibold text-center mb-4 text-orange-900">Distribui√ß√£o de Atividades por Pilar</h3>
                        <div class="chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="capacitacao" class="tab-content hidden space-y-6">
                <header>
                    <h2 class="text-2xl font-bold text-orange-900">üë• Alinhamento e Capacita√ß√£o</h2>
                    <p class="text-gray-600 mt-1">Atividades voltadas para a forma√ß√£o e integra√ß√£o da equipe do projeto. **Adicione as datas de execu√ß√£o para cada item.**</p>
                </header>
                
                <!-- Formul√°rio de Adi√ß√£o de Atividade de Capacita√ß√£o -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-800 mb-3">Adicionar Nova Atividade de Capacita√ß√£o</h3>
                    <form id="add-capacitacao-form" class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="new-cap-title" placeholder="T√≠tulo da Atividade (Ex: Treinamento SIMLAM)" class="flex-grow p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>
                        <input type="date" id="new-cap-date" class="p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 w-full sm:w-1/3" required>
                        <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors shrink-0">Adicionar</button>
                    </form>
                </div>

                <!-- Lista Din√¢mica de Atividades de Capacita√ß√£o -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-900 mb-4">Registro de Execu√ß√£o</h3>
                    <div id="capacitacao-list" class="space-y-3">
                        <!-- Activities generated here by JavaScript -->
                    </div>
                </div>
            </section>

            <section id="fluxo" class="tab-content hidden space-y-6">
                <header>
                    <h2 class="text-2xl font-bold text-orange-900">‚öôÔ∏è Desenvolvimento do Fluxo Operacional</h2>
                    <p class="text-gray-600 mt-1">Engenharia e formaliza√ß√£o dos processos de trabalho para an√°lise e gest√£o dos cadastros. **Clique e arraste os blocos para editar ou reordenar as etapas.**</p>
                </header>

                <div class="bg-white p-4 rounded-lg shadow-md flex justify-end">
                    <button id="add-flow-step-button" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors text-sm">
                        + Adicionar Nova Etapa
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <h3 class="text-lg font-semibold text-orange-800 mb-6 text-center whitespace-nowrap">Etapas do Fluxo (Arraste para Reordenar)</h3>
                    
                    <div id="flowchart-container" class="flex flex-col md:flex-row items-stretch md:items-center justify-start md:justify-center space-y-4 md:space-y-0 md:space-x-2">
                        <!-- Steps are generated here by JavaScript -->
                    </div>
                </div>
            </section>

            <section id="ti" class="tab-content hidden space-y-6">
                 <header>
                    <h2 class="text-2xl font-bold text-orange-900">üíª TI e Automa√ß√£o</h2>
                    <p class="text-gray-600 mt-1">Painel Kanban para gerenciar demandas e alinhamentos para otimizar as tarefas operacionais. Clique em um cart√£o para visualizar detalhes, editar ou remover.</p>
                </header>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-800 mb-4">Adicionar Nova Demanda de Automa√ß√£o</h3>
                    <form id="add-demand-form" class="flex flex-col gap-2">
                        <input type="text" id="new-demand-title" placeholder="T√≠tulo da Demanda (Ex: API de eDocs)" class="flex-grow p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>
                        <div class="flex flex-col sm:flex-row gap-2">
                             <input type="text" id="new-demand-responsible" placeholder="Respons√°vel (Nome)" class="p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 w-full sm:w-1/2">
                             <input type="text" id="new-demand-description" placeholder="Descri√ß√£o breve ou completa da demanda" class="p-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 w-full sm:w-1/2" required>
                        </div>
                        <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Adicionar Demanda</button>
                    </form>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-900 mb-4">Acompanhamento de Demandas (Kanban)</h3>
                    <div id="ti-demands-board" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <div id="col-Demanda" class="bg-gray-100 p-3 rounded-lg">
                            <h4 class="font-bold text-lg text-red-700 mb-3">üìã Demanda (<span data-count="Demanda">0</span>)</h4>
                            <div class="cards-wrapper space-y-3 min-h-[50px]">
                                <!-- Cart√µes gerados via JavaScript -->
                            </div>
                        </div>
                        
                        <div id="col-Em Execu√ß√£o" class="bg-gray-100 p-3 rounded-lg">
                            <h4 class="font-bold text-lg text-yellow-700 mb-3">üõ†Ô∏è Em Execu√ß√£o (<span data-count="Em Execu√ß√£o">0</span>)</h4>
                             <div class="cards-wrapper space-y-3 min-h-[50px]">
                                <!-- Cart√µes gerados via JavaScript -->
                            </div>
                        </div>
                        
                        <div id="col-Conclu√≠da" class="bg-gray-100 p-3 rounded-lg">
                            <h4 class="font-bold text-lg text-green-700 mb-3">‚úÖ Conclu√≠da (<span data-count="Conclu√≠da">0</span>)</h4>
                            <div class="cards-wrapper space-y-3 min-h-[50px]">
                                <!-- Cart√µes gerados via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-orange-800 mb-4">Alinhamento e Integra√ß√µes (Foco)</h3>
                    <ul class="space-y-3 text-gray-700 list-disc list-inside">
                        <li>Identifica√ß√£o do contato respons√°vel pelas APIs do eDocs e direcionamento para a TI do Ifes-Cachoeiro.</li>
                        <li>Alinhamento cont√≠nuo com a TI sobre atividades manuais e o roadmap de automa√ß√£o.</li>
                        <li>Cria√ß√£o de diagrama com o fluxo operacional e as atividades da TI.</li>
                    </ul>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal de Detalhes/Edi√ß√£o -->
    <div id="demand-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold text-orange-900 mb-4" id="modal-title-display">Detalhes da Demanda</h3>
            <form id="edit-demand-form" class="space-y-4">
                <input type="hidden" id="modal-demand-id">
                
                <div>
                    <label for="modal-title" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
                    <input type="text" id="modal-title" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required>
                </div>

                <div>
                    <label for="modal-description" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                    <textarea id="modal-description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" required></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="modal-start-date" class="block text-sm font-medium text-gray-700">Data de In√≠cio</label>
                        <input type="date" id="modal-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="modal-end-date" class="block text-sm font-medium text-gray-700">Data de T√©rmino</label>
                        <input type="date" id="modal-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500" disabled>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="modal-responsible" class="block text-sm font-medium text-gray-700">Respons√°vel</label>
                        <input type="text" id="modal-responsible" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="modal-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="modal-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                            <option value="Demanda">Demanda</option>
                            <option value="Em Execu√ß√£o">Em Execu√ß√£o</option>
                            <option value="Conclu√≠da">Conclu√≠da</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-between pt-4 border-t border-gray-100">
                    <button type="button" id="delete-demand-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Remover</button>
                    <div class="space-x-2">
                        <button type="button" id="close-modal-button" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Fechar</button>
                        <button type="submit" class="bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- FUN√á√ïES AUXILIARES DE DATA E TEXTO ---

            // Fun√ß√£o para obter o nome do m√™s em portugu√™s
            function getMonthName(monthNumber) {
                const monthNames = [
                    "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
                ];
                return monthNames[monthNumber - 1];
            }

            // FUN√á√ÉO AUXILIAR PARA PEGAR A DATA DE HOJE (YYYY-MM-DD)
            function getTodayDateFormatted() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // FUN√á√ÉO AUXILIAR DE DATA PARA EXIBI√á√ÉO (DD/MM/YYYY)
            function formatDateDisplay(dateString) {
                if (!dateString) return 'N/A';
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            }
            
            // --- DADOS INICIAIS ---
            
            // DADOS DO KANBAN (TI) - Foco em OUTUBRO/2025
            const initialTIDemands = [
                { id: 1, title: "Buscar APPs para Pagina√ß√£o", desc: "Achar e testar APPs para paginar e eliminar p√°ginas vazias de documentos digitalizados.", status: "Conclu√≠da", responsible: "Jo√£o P.", startDate: "2025-10-01", endDate: "2025-10-30" }, 
                { id: 2, title: "Of√≠cio de Encerramento Autom√°tico", desc: "Confec√ß√£o autom√°tica de of√≠cio de encerramento a partir de documentos digitalizados.", status: "Demanda", responsible: "TI Ifes", startDate: "2025-10-05", endDate: "" }, 
                { id: 3, title: "Gera√ß√£o de Planilha Autom√°tica", desc: "Gerar planilha autom√°tica com colunas (Documento, Nome, N√∫mero) a partir de arquivos digitalizados.", status: "Em Execu√ß√£o", responsible: "Maria C.", startDate: "2025-10-15", endDate: "" },
                { id: 4, title: "Relat√≥rio de An√°lise via API", desc: "Gerar an√°lise documental via API, criando um relat√≥rio que vincula o resultado da an√°lise com o SIMLAM.", status: "Demanda", responsible: "TI Ifes", startDate: "2025-10-25", endDate: "" }
            ];
            let tiDemands = [...initialTIDemands];
            let nextId = 5;

            // DADOS DO FLUXO OPERACIONAL (din√¢mico e edit√°vel)
            let flowSteps = [
                { id: 101, title: "Estudo de Base", desc: "Visita ao IDAF para visualizar a organiza√ß√£o e o fluxo operacional existente." },
                { id: 102, title: "Design de Processos", desc: "Desenvolvimento e burocratiza√ß√£o do novo fluxo entre Bolsistas, Orientadores e Consultores." },
                { id: 103, title: "Organiza√ß√£o", desc: "Cria√ß√£o de uma estrutura de pastas para o acompanhamento dos processos." },
                { id: 104, title: "An√°lise de Documentos", desc: "Revis√£o e valida√ß√£o dos documentos digitalizados (eDocs)." },
                { id: 105, title: "An√°lise de Mapas (CAR)", desc: "Valida√ß√£o dos limites e classes do CAR com ferramentas de geoprocessamento." },
                { id: 106, title: "Finaliza√ß√£o do Processo", desc: "Elabora√ß√£o de of√≠cio de encerramento e envio para o SIMLAM/eDocs." }
            ];
            let nextFlowId = 107;
            let draggingStep = null;

            // DADOS DE CAPACITA√á√ÉO (din√¢mico e com data) - Foco em SETEMBRO/2025
            let capacitacaoActivities = [
                { id: 201, title: "Sele√ß√£o dos bolsistas do projeto atrav√©s de entrevista, conforme edital.", date: "2025-09-10", completed: true },
                { id: 202, title: "Curso de capacita√ß√£o para gera√ß√£o de CAR, ministrado pela equipe IDAF e convidados.", date: "2025-09-20", completed: true },
                { id: 203, title: "Alinhamento com a equipe de TI do Ifes-Cachoeiro sobre ferramentas de aux√≠lio.", date: "2025-09-25", completed: true },
                { id: 204, title: "Reuni√£o geral sobre a evolu√ß√£o dos trabalhos e apresenta√ß√£o do fluxo do analista CAR.", date: "2025-10-15", completed: false }, 
                { id: 205, title: "Revis√£o de documentos e alinhamento do escopo para fase 2 do projeto.", date: "2025-11-05", completed: false }
            ];
            let nextCapId = 206;

            // Vari√°veis de escopo
            let tasksChartInstance = null;
            let currentFilter = { month: null, year: null }; // Guarda o filtro atual

            // Refer√™ncias do Modal (TI Kanban)
            const modal = document.getElementById('demand-modal');
            const editForm = document.getElementById('edit-demand-form');
            const closeModalButton = document.getElementById('close-modal-button');
            const deleteDemandButton = document.getElementById('delete-demand-button');
            
            // Refer√™ncias do Filtro
            const filterForm = document.getElementById('report-filter-form');
            const filterMonthSelect = document.getElementById('filter-month');
            const filterYearSelect = document.getElementById('filter-year');
            const reportStatus = document.getElementById('report-status');

            // --- L√ìGICA DE FILTRO E EXPORTA√á√ÉO (.DOC - Formato CNPq/Artigo) ---

            const months = [
                { value: 9, label: "Setembro" },
                { value: 10, label: "Outubro" },
                { value: 11, label: "Novembro" },
                { value: 12, label: "Dezembro" }
            ];
            const years = [2024, 2025]; // Anos relevantes

            function populateFilterSelectors() {
                // M√™s
                filterMonthSelect.innerHTML = '<option value="" disabled selected>Selecione o M√™s</option>';
                months.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.value;
                    option.textContent = m.label;
                    filterMonthSelect.appendChild(option);
                });

                // Ano
                filterYearSelect.innerHTML = '<option value="" disabled selected>Selecione o Ano</option>';
                years.forEach(y => {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    filterYearSelect.appendChild(option);
                });

                // Define Outubro/2025 como padr√£o (m√™s mais recente nos dados)
                filterMonthSelect.value = 10; 
                filterYearSelect.value = 2025;
            }

            function filterActivities(month, year) {
                currentFilter = { month, year };
                
                if (!month || !year) {
                    reportStatus.textContent = 'Selecione M√™s e Ano para filtrar.';
                    reportStatus.classList.remove('hidden', 'text-green-700', 'text-red-700');
                    return { month, year, filteredCapacitacao: capacitacaoActivities, filteredTIDemands: tiDemands }; 
                }

                const targetMonth = parseInt(month);
                const targetYear = parseInt(year);

                // 1. FILTRO DE CAPACITA√á√ÉO (pela data de execu√ß√£o)
                const filteredCapacitacao = capacitacaoActivities.filter(activity => {
                    const activityDate = new Date(activity.date + 'T00:00:00'); 
                    return activityDate.getMonth() + 1 === targetMonth && activityDate.getFullYear() === targetYear;
                });

                // 2. FILTRO DE TI (pela data de in√≠cio, fim ou se o per√≠odo cobre o m√™s)
                const filteredTIDemands = tiDemands.filter(demand => {
                    const start = new Date(demand.startDate + 'T00:00:00');
                    const end = demand.endDate ? new Date(demand.endDate + 'T00:00:00') : new Date(getTodayDateFormatted() + 'T00:00:00'); // Se n√£o tem fim, usa a data atual (hoje)
                    
                    const targetStart = new Date(targetYear, targetMonth - 1, 1); // Primeiro dia do m√™s
                    const targetEnd = new Date(targetYear, targetMonth, 0); // √öltimo dia do m√™s

                    // Crit√©rio: A demanda est√° ativa no m√™s (in√≠cio <= fim do m√™s E fim >= in√≠cio do m√™s)
                    return start <= targetEnd && end >= targetStart;
                });
                
                const totalFiltered = filteredCapacitacao.length + flowSteps.length + filteredTIDemands.length;

                reportStatus.textContent = `Relat√≥rio para ${getMonthName(targetMonth)}/${targetYear} gerado. Total: ${totalFiltered} atividades.`;
                reportStatus.classList.remove('hidden', 'text-red-700');
                reportStatus.classList.add('text-green-700');

                return { month: targetMonth, year: targetYear, filteredCapacitacao, filteredTIDemands };
            }

            // Fun√ß√£o para gerar e baixar o arquivo .doc no FORMATO ARTIGO CNPQ
            function generateDocxReport(month, year, filteredCapacitacao, flowAct, filteredTIDemands) {
                const monthName = getMonthName(month);
                const dateTitle = `${monthName} de ${year}`;
                const totalActivities = filteredCapacitacao.length + flowAct.length + filteredTIDemands.length;
                const completedCapacitacaoCount = filteredCapacitacao.filter(a => a.completed).length;


                // --- HTML Structure for the Word Document (.doc format) - ACADEMIC STYLE ---
                let reportContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="utf-8">
                        <title>Relat√≥rio CNPq - IntegraCAR - ${dateTitle}</title>
                        <style>
                            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 40px; }
                            h1 { font-size: 18pt; font-weight: bold; text-align: center; margin-bottom: 5px; }
                            h2 { font-size: 14pt; font-weight: bold; margin-top: 25px; margin-bottom: 10px; color: #000; }
                            h3 { font-size: 12pt; font-weight: bold; margin-top: 15px; margin-bottom: 8px; color: #555; }
                            p { font-size: 11pt; margin-bottom: 15px; text-align: justify; }
                            table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 10pt;}
                            th { background-color: #f0f0f0; color: #333; font-weight: bold; }
                            .status-concluida { color: #059669; font-weight: bold; }
                            .status-demanda { color: #DC2626; font-weight: bold; }
                            .status-em-execucao { color: #D97706; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        
                        <!-- T√çTULO E AUTORES -->
                        <div style="text-align: center;">
                            <h1>Relat√≥rio de Progresso e Mapeamento de Atividades do Projeto IntegraCAR</h1>
                            <p style="font-size: 12pt; margin-top: 0; margin-bottom: 5px;">Relat√≥rio CNPq - Per√≠odo de ${dateTitle}</p>
                            <p style="font-size: 11pt; font-style: italic; margin-bottom: 40px; color: #555;">Autor: Equipe de Projeto IntegraCAR | Data: ${formatDateDisplay(getTodayDateFormatted()).replace(/\//g, '-')}</p>
                        </div>
                        
                        <!-- 1. RESUMO -->
                        <h2>1. RESUMO</h2>
                        <p>
                            O presente relat√≥rio abrange as atividades do Projeto IntegraCAR no per√≠odo de ${dateTitle}, com foco na otimiza√ß√£o da an√°lise de Cadastros Ambientais Rurais (CAR). O mapeamento identificou um total de ${totalActivities} atividades relevantes, distribu√≠das em tr√™s pilares: Capacita√ß√£o, Fluxo Operacional e TI & Automa√ß√£o. Os principais resultados incluem a formaliza√ß√£o da metodologia de an√°lise (${flowAct.length} etapas definidas) e o avan√ßo em ${completedCapacitacaoCount}/${filteredCapacitacao.length} atividades de capacita√ß√£o, fundamentais para a padroniza√ß√£o e escalabilidade do processo.
                        </p>

                        <!-- 2. INTRODU√á√ÉO E OBJETIVOS -->
                        <h2>2. INTRODU√á√ÉO E OBJETIVOS</h2>
                        <p>
                            O Projeto IntegraCAR visa desenvolver uma metodologia robusta e automatizada para a valida√ß√£o de processos do CAR, em colabora√ß√£o com o IDAF. O objetivo principal deste documento √© registrar as entregas e o status dos processos operacionais e tecnol√≥gicos, conforme a estrutura de acompanhamento e presta√ß√£o de contas do CNPq, demonstrando a evolu√ß√£o das atividades do plano de trabalho no per√≠odo.
                        </p>

                        <!-- 3. METODOLOGIA (FLUXO OPERACIONAL) -->
                        <h2>3. METODOLOGIA: O FLUXO OPERACIONAL DE AN√ÅLISE</h2>
                        <p>
                            A metodologia de trabalho √© definida pela sequ√™ncia de etapas formalizadas para a an√°lise dos documentos e mapas do CAR, garantindo a rastreabilidade e a qualidade do processo. O fluxo operacional √© composto por ${flowAct.length} etapas, representando o processo padr√£o de an√°lise e gest√£o dos cadastros:
                        </p>
                        
                        <!-- LISTA ORDENADA DO FLUXO -->
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            ${flowAct.map((f, index) => `
                                <li style="font-size: 11pt; margin-bottom: 8px;">
                                    <strong>${f.title}:</strong> ${f.desc}
                                </li>
                            `).join('')}
                            ${flowAct.length === 0 ? '<p style="font-size: 11pt; font-style: italic;">Nenhuma etapa de fluxo operacional definida.</p>' : ''}
                        </ol>

                        <!-- 4. RESULTADOS E DISCUSS√ÉO -->
                        <h2>4. RESULTADOS E DISCUSS√ÉO</h2>
                        <p>
                            Os resultados no per√≠odo concentraram-se na execu√ß√£o das a√ß√µes de capacita√ß√£o, na homologa√ß√£o do fluxo metodol√≥gico e no avan√ßo das demandas de automa√ß√£o para a TI.
                        </p>
                        
                        <!-- SUB-SE√á√ÉO CAPACITA√á√ÉO -->
                        <h3>4.1. A√ß√µes de Alinhamento e Capacita√ß√£o</h3>
                        <table>
                            <thead>
                                <tr><th>Atividade</th><th>Data de Execu√ß√£o</th><th>Status</th></tr>
                            </thead>
                            <tbody>
                                ${filteredCapacitacao.map(a => `
                                    <tr>
                                        <td>${a.title}</td>
                                        <td>${formatDateDisplay(a.date)}</td>
                                        <td>${a.completed ? '<span class="status-concluida">Conclu√≠da</span>' : 'Pendente'}</td>
                                    </tr>
                                `).join('')}
                                ${filteredCapacitacao.length === 0 ? '<tr><td colspan="3">Nenhuma atividade de Capacita√ß√£o registrada neste per√≠odo.</td></tr>' : ''}
                            </tbody>
                        </table>
                        
                        <!-- SUB-SE√á√ÉO TI -->
                        <h3>4.2. Tecnologia e Automa√ß√£o (Demandas Ativas ou Conclu√≠das)</h3>
                        <table>
                            <thead>
                                <tr><th>Demanda</th><th>Respons√°vel</th><th>Status</th><th>In√≠cio</th><th>T√©rmino</th></tr>
                            </thead>
                            <tbody>
                                ${filteredTIDemands.map(d => `
                                    <tr>
                                        <td>${d.title}</td>
                                        <td>${d.responsible || 'N/A'}</td>
                                        <td class="status-${d.status.toLowerCase().replace(/ /g, '-')}">${d.status}</td>
                                        <td>${formatDateDisplay(d.startDate)}</td>
                                        <td>${formatDateDisplay(d.endDate)}</td>
                                    </tr>
                                `).join('')}
                                ${filteredTIDemands.length === 0 ? '<tr><td colspan="5">Nenhuma demanda de TI & Automa√ß√£o registrada neste per√≠odo.</td></tr>' : ''}
                            </tbody>
                        </table>

                        <!-- 5. CONCLUS√ÉO -->
                        <h2>5. CONCLUS√ÉO</h2>
                        <p>
                            O projeto IntegraCAR demonstrou progresso significativo no per√≠odo, com a consolida√ß√£o da metodologia de trabalho (Se√ß√£o 3) e o avan√ßo das atividades de capacita√ß√£o e tecnol√≥gica (Se√ß√£o 4). A equipe atingiu o √≠ndice de ${completedCapacitacaoCount}/${filteredCapacitacao.length} atividades de forma√ß√£o conclu√≠das e direcionou as demandas necess√°rias para automa√ß√£o. O pr√≥ximo per√≠odo de relat√≥rio focar√° na homologa√ß√£o das solu√ß√µes de TI e na aplica√ß√£o do fluxo operacional na an√°lise em lote dos cadastros para cumprir as metas estabelecidas.
                        </p>

                    </body>
                    </html>
                `;

                // Download Logic (Saves as .doc for Word compatibility)
                const fileName = `Relatorio_CNPq_IntegraCAR_${monthName}_${year}.doc`;
                const mimeType = 'application/msword';
                
                // Create a Blob containing the HTML content
                const blob = new Blob([reportContent], { type: mimeType });

                // Download using a temporary link element
                const a = document.createElement('a');
                const url = URL.createObjectURL(blob);
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Atualiza o status
                reportStatus.textContent += ' O download do relat√≥rio (.doc) foi iniciado no formato Artigo CNPq.';
            }


            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const month = filterMonthSelect.value;
                const year = filterYearSelect.value;
                
                if (!month || !year) {
                    filterActivities(month, year); // Apenas mostra a mensagem de erro se o filtro estiver incompleto
                    return;
                }

                const { month: filteredMonth, year: filteredYear, filteredCapacitacao, filteredTIDemands } = filterActivities(month, year);
                
                // 1. Atualiza a Vis√£o Geral na tela
                updateDashboard(filteredCapacitacao, flowSteps, filteredTIDemands);

                // 2. Gera e baixa o Documento (.doc)
                generateDocxReport(filteredMonth, filteredYear, filteredCapacitacao, flowSteps, filteredTIDemands);
            });

            // --- FUN√á√ïES GERAIS DE ATUALIZA√á√ÉO DO PAINEL ---
            function updateDashboard(capActivities = capacitacaoActivities, flowAct = flowSteps, tiAct = tiDemands) {
                
                const currentChartData = {
                    capacitacao: capActivities.length,
                    fluxo: flowAct.length,
                    ti: tiAct.length
                };

                const totalActivities = currentChartData.capacitacao + currentChartData.fluxo + currentChartData.ti;
                document.getElementById('total-activities-count').textContent = totalActivities;

                if (tasksChartInstance) {
                    tasksChartInstance.data.datasets[0].data = Object.values(currentChartData);
                    tasksChartInstance.update();
                }

                // A remo√ß√£o das chamadas recursivas foi a corre√ß√£o do RangeError.
            }
            
            // --- FUN√á√ïES DE CAPACITA√á√ÉO (CRUD) ---

            function renderCapacitacaoActivities() {
                const listContainer = document.getElementById('capacitacao-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                
                // Ordena por data (mais recente primeiro)
                const sortedActivities = [...capacitacaoActivities].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedActivities.forEach(activity => {
                    const dateDisplay = formatDateDisplay(activity.date);
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'capacitacao-list-item flex items-start justify-between p-3 rounded-lg border border-orange-200 transition-colors hover:bg-orange-50 relative';
                    itemDiv.setAttribute('data-id', activity.id);
                    
                    const statusIcon = activity.completed ? 
                        `<span class="text-green-500 mr-3 text-lg shrink-0">‚úîÔ∏è</span>` :
                        `<span class="text-yellow-500 mr-3 text-lg shrink-0">‚è≥</span>`;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn text-gray-400 hover:text-red-600 p-1 rounded-full ml-3 shrink-0 opacity-0 transition-opacity absolute top-1 right-1';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Remover Atividade';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm('Tem certeza que deseja remover esta atividade?')) {
                             deleteCapacitacaoActivity(activity.id);
                        }
                    };

                    itemDiv.innerHTML = `
                        <div class="flex items-start flex-1 pr-10">
                            ${statusIcon}
                            <div>
                                <p class="text-sm font-medium text-gray-800">${activity.title}</p>
                                <p class="text-xs text-gray-500 mt-0.5">Execu√ß√£o: <span class="font-semibold text-orange-700">${dateDisplay}</span></p>
                            </div>
                        </div>
                    `;
                    itemDiv.appendChild(deleteBtn);
                    listContainer.appendChild(itemDiv);
                });
            }

            // Fun√ß√µes CRUD para Capacita√ß√£o
            const addCapacitacaoForm = document.getElementById('add-capacitacao-form');
            addCapacitacaoForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const titleInput = document.getElementById('new-cap-title');
                const dateInput = document.getElementById('new-cap-date');
                
                const newTitle = titleInput.value.trim();
                const newDate = dateInput.value;

                if (newTitle && newDate) {
                    // Considera conclu√≠da se a data for anterior ou igual a hoje
                    const isCompleted = new Date(newDate) <= new Date(getTodayDateFormatted());

                    capacitacaoActivities.push({
                        id: nextCapId++,
                        title: newTitle,
                        date: newDate,
                        completed: isCompleted 
                    });
                    
                    titleInput.value = '';
                    dateInput.value = ''; 
                    
                    renderCapacitacaoActivities();
                    updateDashboard(); 
                }
            });

            function deleteCapacitacaoActivity(id) {
                capacitacaoActivities = capacitacaoActivities.filter(a => a.id !== id);
                renderCapacitacaoActivities();
                updateDashboard(); 
            }

            // --- FUN√á√ïES DE FLUXO OPERACIONAL (CRUD e Drag/Drop) ---

            function renderFlowSteps() {
                const container = document.getElementById('flowchart-container');
                if (!container) return;
                container.innerHTML = '';
                
                flowSteps.forEach((step, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'flowchart-step text-center bg-orange-100 p-3 rounded-lg border border-orange-200 w-full md:flex-1 shrink-0 h-full relative group';
                    stepDiv.setAttribute('data-id', step.id);
                    stepDiv.setAttribute('draggable', 'true');
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'absolute top-1 right-1 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded-full bg-orange-100/70 z-10 text-xl leading-none';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Remover Etapa';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        if (confirm('Tem certeza que deseja remover esta etapa do fluxo?')) {
                             deleteFlowStep(step.id);
                        }
                    };
                    
                    stepDiv.innerHTML = `
                        <div class="text-lg mb-1 font-semibold">${index + 1}</div>
                        <h4 class="font-bold text-sm mb-1 edit-title" contenteditable="true" data-id="${step.id}">${step.title}</h4>
                        <p class="text-xs text-gray-600 mt-1 edit-desc" contenteditable="true" data-id="${step.id}">${step.desc}</p>
                    `;
                    stepDiv.appendChild(deleteBtn);
                    
                    container.appendChild(stepDiv);
                    
                    if (index < flowSteps.length - 1) {
                        const arrowDiv = document.createElement('div');
                        arrowDiv.className = 'flowchart-arrow self-center hidden md:block';
                        arrowDiv.innerHTML = '‚Üí';
                        container.appendChild(arrowDiv);
                    }
                });
                
                addFlowListeners();
            }

            function addFlowListeners() {
                document.querySelectorAll('.flowchart-step').forEach(step => {
                    step.addEventListener('dragstart', handleDragStart);
                    step.addEventListener('dragover', handleDragOver);
                    step.addEventListener('dragleave', handleDragLeave);
                    step.addEventListener('drop', handleDrop);
                    step.addEventListener('dragend', handleDragEnd);
                });
                
                document.querySelectorAll('.edit-title, .edit-desc').forEach(el => {
                    el.addEventListener('blur', updateFlowStep);
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); 
                            el.blur();
                        }
                    });
                });
            }

            document.getElementById('add-flow-step-button').addEventListener('click', () => {
                 flowSteps.push({
                    id: nextFlowId++,
                    title: "Nova Etapa",
                    desc: "Adicione uma descri√ß√£o para esta etapa."
                });
                renderFlowSteps();
                updateDashboard(); 
            });

            function deleteFlowStep(id) {
                flowSteps = flowSteps.filter(step => step.id !== id);
                renderFlowSteps();
                updateDashboard(); 
            }

            function updateFlowStep(e) {
                const element = e.target;
                const id = parseInt(element.getAttribute('data-id'));
                const step = flowSteps.find(s => s.id === id);
                if (!step) return;
                
                const value = element.textContent.trim();
                
                if (element.classList.contains('edit-title')) {
                    step.title = value || "T√≠tulo Vazio";
                } else if (element.classList.contains('edit-desc')) {
                    step.desc = value;
                }
            }

            // Drag and Drop Logic (mantido o mesmo)
            function handleDragStart(e) {
                draggingStep = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
                setTimeout(() => this.classList.add('opacity-40', 'shadow-xl'), 0); 
            }

            function handleDragOver(e) {
                e.preventDefault();
                const stepElement = this;
                if (stepElement.classList.contains('flowchart-step') && stepElement !== draggingStep) {
                    const rect = stepElement.getBoundingClientRect();
                    const midpoint = (rect.left + rect.right) / 2;
                    
                    stepElement.style.borderLeft = '';
                    stepElement.style.borderRight = '';
                    
                    if (e.clientX < midpoint) {
                        stepElement.style.borderLeft = '4px solid #c2410c'; 
                    } else {
                        stepElement.style.borderRight = '4px solid #c2410c'; 
                    }
                }
            }

            function handleDragLeave() {
                this.style.borderLeft = '';
                this.style.borderRight = '';
            }

            function handleDrop(e) {
                e.stopPropagation();
                e.preventDefault();

                this.style.borderLeft = '';
                this.style.borderRight = '';

                if (draggingStep && draggingStep !== this) {
                    const draggedId = parseInt(draggingStep.getAttribute('data-id'));
                    const targetId = parseInt(this.getAttribute('data-id'));

                    const draggedIndex = flowSteps.findIndex(s => s.id === draggedId);
                    
                    if (draggedIndex === -1) return;

                    const [movedStep] = flowSteps.splice(draggedIndex, 1);
                    
                    const currentTargetIndex = flowSteps.findIndex(s => s.id === targetId);

                    const rect = this.getBoundingClientRect();
                    const midpoint = (rect.left + rect.right) / 2;
                    
                    if (e.clientX > midpoint) {
                         flowSteps.splice(currentTargetIndex + 1, 0, movedStep);
                    } else {
                         flowSteps.splice(currentTargetIndex, 0, movedStep);
                    }
                    
                    renderFlowSteps(); 
                }
            }

            function handleDragEnd() {
                this.classList.remove('opacity-40', 'shadow-xl');
                this.style.borderLeft = '';
                this.style.borderRight = '';
                draggingStep = null;
            }
            
            // --- FIM DAS FUN√á√ïES DE FLUXO OPERACIONAL ---


            // FUN√á√ïES KANBAN E RENDERIZA√á√ÉO
            function renderTIDemands() {
                const boardColumns = {
                    "Demanda": document.getElementById('col-Demanda').querySelector('.cards-wrapper'),
                    "Em Execu√ß√£o": document.getElementById('col-Em Execu√ß√£o').querySelector('.cards-wrapper'),
                    "Conclu√≠da": document.getElementById('col-Conclu√≠da').querySelector('.cards-wrapper')
                };

                let demandCounts = { "Demanda": 0, "Em Execu√ß√£o": 0, "Conclu√≠da": 0 };
                Object.values(boardColumns).forEach(col => { col.innerHTML = ''; });

                tiDemands.forEach(demand => {
                    const descPreview = demand.desc.substring(0, 90) + (demand.desc.length > 90 ? '...' : '');
                    const formattedStart = formatDateDisplay(demand.startDate);
                    const formattedEnd = formatDateDisplay(demand.endDate);
                    
                    const itemHtml = `
                        <div data-id="${demand.id}" class="kanban-card bg-white p-3 rounded-lg shadow-sm border border-orange-200 cursor-pointer transition-shadow duration-150">
                            <h5 class="font-bold text-sm text-orange-900">${demand.title}</h5>
                            <p class="text-xs text-gray-500 mt-1 mb-2">${descPreview}</p>
                            <p class="text-xs font-medium text-gray-700">In√≠cio: <span class="font-semibold">${formattedStart}</span></p>
                            <p class="text-xs font-medium text-gray-700">T√©rmino: <span class="font-semibold">${formattedEnd}</span></p>
                            <p class="text-xs font-medium text-gray-700">Resp: <span class="font-semibold">${demand.responsible || 'N√£o Definido'}</span></p>
                        </div>`;
                    
                    const colWrapper = boardColumns[demand.status];
                    if (colWrapper) {
                         colWrapper.insertAdjacentHTML('beforeend', itemHtml);
                         demandCounts[demand.status]++;
                    }
                });
                
                document.querySelectorAll(`#ti-demands-board [data-count]`).forEach(countEl => {
                    const status = countEl.closest('[id^="col-"]').id.replace('col-', '');
                    countEl.textContent = demandCounts[status] || 0;
                });
                
                document.querySelectorAll('.kanban-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = parseInt(card.getAttribute('data-id'));
                        openDemandModal(id);
                    });
                });
            }
            
            function toggleEndDateInput(status) {
                const endDateInput = document.getElementById('modal-end-date');
                if (status === 'Conclu√≠da') {
                    endDateInput.disabled = false;
                    // Se estiver em 'Conclu√≠da' e n√£o tiver data de t√©rmino, preenche com a data atual (do browser)
                    if (!endDateInput.value) {
                         endDateInput.value = getTodayDateFormatted();
                    }
                } else {
                    endDateInput.disabled = true;
                }
            }

            // FUN√á√ïES DO MODAL (TI Kanban)
            function openDemandModal(id) {
                const demand = tiDemands.find(d => d.id === id);
                if (!demand) return;

                document.getElementById('modal-demand-id').value = demand.id;
                document.getElementById('modal-title').value = demand.title;
                document.getElementById('modal-description').value = demand.desc;
                document.getElementById('modal-responsible').value = demand.responsible;
                document.getElementById('modal-status').value = demand.status;
                
                document.getElementById('modal-start-date').value = demand.startDate || '';
                document.getElementById('modal-start-date').disabled = false; 

                document.getElementById('modal-end-date').value = demand.endDate || '';

                toggleEndDateInput(demand.status);

                document.getElementById('modal-title-display').textContent = demand.title;

                modal.classList.remove('invisible', 'opacity-0');
                modal.classList.add('visible', 'opacity-100');
            }

            function closeDemandModal() {
                modal.classList.remove('visible', 'opacity-100');
                modal.classList.add('invisible', 'opacity-0');
            }

            // EVENTOS DO MODAL (TI Kanban)
            closeModalButton.addEventListener('click', closeDemandModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeDemandModal(); 
            });

            document.getElementById('modal-status').addEventListener('change', function(e) {
                toggleEndDateInput(e.target.value);
            });

            editForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const id = parseInt(document.getElementById('modal-demand-id').value);
                const demandIndex = tiDemands.findIndex(d => d.id === id);

                if (demandIndex > -1) {
                    const newStatus = document.getElementById('modal-status').value;
                    const newStartDate = document.getElementById('modal-start-date').value; 
                    const newEndDate = document.getElementById('modal-end-date').value;

                    let finalEndDate = newEndDate;
                    if (newStatus !== 'Conclu√≠da') {
                        finalEndDate = '';
                    }

                    tiDemands[demandIndex].title = document.getElementById('modal-title').value.trim();
                    tiDemands[demandIndex].desc = document.getElementById('modal-description').value.trim();
                    tiDemands[demandIndex].responsible = document.getElementById('modal-responsible').value.trim();
                    tiDemands[demandIndex].status = newStatus;
                    tiDemands[demandIndex].startDate = newStartDate; 
                    tiDemands[demandIndex].endDate = finalEndDate; 
                    
                    renderTIDemands();
                    updateDashboard();
                    closeDemandModal();
                }
            });

            deleteDemandButton.addEventListener('click', function() {
                const id = parseInt(document.getElementById('modal-demand-id').value);
                if (confirm('Tem certeza que deseja remover esta demanda de TI?')) {
                    tiDemands = tiDemands.filter(d => d.id !== id);
                    
                    renderTIDemands();
                    updateDashboard();
                    closeDemandModal();
                }
            });

            // L√ìGICA DO FORMUL√ÅRIO DE ADI√á√ÉO (TI Kanban)
            document.getElementById('add-demand-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const titleInput = document.getElementById('new-demand-title');
                const responsibleInput = document.getElementById('new-demand-responsible');
                const descriptionInput = document.getElementById('new-demand-description');
                
                const newTitle = titleInput.value.trim();
                const newResponsible = responsibleInput.value.trim() || 'Aguardando Defini√ß√£o';
                const newDescription = descriptionInput.value.trim();

                if (newTitle && newDescription) {
                    tiDemands.push({ 
                        id: nextId++,
                        title: newTitle, 
                        desc: newDescription, 
                        status: "Demanda", 
                        responsible: newResponsible,
                        startDate: getTodayDateFormatted(), 
                        endDate: ''   
                    });
                    
                    titleInput.value = '';
                    responsibleInput.value = '';
                    descriptionInput.value = '';
                    
                    renderTIDemands();
                    updateDashboard();
                }
            });
            
            // L√ìGICA DAS ABAS
            const tabs = document.querySelectorAll('nav button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    contents.forEach(content => {
                        content.id === target ? content.classList.remove('hidden') : content.classList.add('hidden');
                    });
                    
                    if (target === 'overview') {
                        // Ao voltar para overview, re-aplica o filtro ativo, ou usa todos os dados.
                        const month = filterMonthSelect.value;
                        const year = filterYearSelect.value;

                        if (month && year) {
                             const { filteredCapacitacao, filteredTIDemands } = filterActivities(month, year);
                             updateDashboard(filteredCapacitacao, flowSteps, filteredTIDemands);
                        } else {
                            updateDashboard();
                        }
                    }
                });
            });

            // INICIALIZA√á√ÉO DO GR√ÅFICO 
            const initializeChart = (data) => {
                if (tasksChartInstance) {
                    tasksChartInstance.destroy();
                }
                const taskChartData = {
                    labels: ['Capacita√ß√£o', 'Fluxo Operacional', 'TI & Automa√ß√£o'],
                    datasets: [{
                        label: 'Atividades por Pilar',
                        data: Object.values(data),
                        backgroundColor: ['#FBBF24', '#F97316', '#92400E'], 
                        borderColor: '#fff7ed',
                        borderWidth: 3,
                        hoverOffset: 4
                    }]
                };
                tasksChartInstance = new Chart(document.getElementById('tasksChart'), {
                    type: 'doughnut',
                    data: taskChartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { family: "'Inter', sans-serif" } } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += context.parsed + ' atividades'; } return label; } } } },
                        cutout: '60%'
                    }
                });
            }

            // RENDERIZA√á√ÉO INICIAL
            populateFilterSelectors();
            renderTIDemands();
            renderFlowSteps(); 
            renderCapacitacaoActivities(); 
            
            const initialChartData = {
                capacitacao: capacitacaoActivities.length,
                fluxo: flowSteps.length,
                ti: tiDemands.length
            };
            initializeChart(initialChartData);
            updateDashboard();
        });
    </script>
</body>
</html>
